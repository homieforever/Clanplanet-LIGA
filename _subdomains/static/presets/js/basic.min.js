// Basic @var's

var cp_login_status = false;
var cp_login_username = "";
var session_id = "";
var cpl_template = null;
var cpl_local_cache = [];
var cpl_login_status = false;

$(document).load(function () {
    if($("#module-login").length > 0)
    {
        if($("#module-login-username").length > 0)
        {
            cp_login_status = true;
            cp_login_username = $("#module-login-username span:nth-child(2)").html();
        }
    }
});


function addParam(url, param, value) {
     var a = document.createElement('a');
     a.href = url;
     a.search += a.search.substring(0,1) == "?" ? "&" : "?";
     a.search += encodeURIComponent(param);
     if (value)
         a.search += "=" + encodeURIComponent(value);
     return a.href;
}


function add_sid(url) {
    url = addParam(url, "SID", session_id);
    url = addParam(url, "sc_set_clanplanet", true);
    return url;
}

function timestamp() {
    return Math.round(+new Date()/1000);
}

function cpl_getParam(name) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(window.location.hash)||[,null])[1]
    );
}

function cpl_checkParam(needle) {
	var check = cpl_getParam(needle);
        if(check === "null")
        {
            return false;
        }
        else
        {
            return true;
        }
}

function api_js(src, callback) {
    $.ajax({
        url: src,
        type: "GET",
        dataType: "script",
        success: function (data)
        {
            if(callback)
            {
                callback(api_answer);
            }
        }
    });
}

function api_get(action, callback, error_callback) {
    $.ajax({
        url: add_sid("http://api.clanplanet-liga.de/"+action),
        success: function (data) {
            if(callback)
            {
                callback(data);
            }
        },
        error: function () {
            if(error_callback)
            {
                error_callback();
            }
        }
    });
}

function api_post(action, data, callback, error_callback) {
    $.ajax({
        url: add_sid("http://api.clanplanet-liga.de/"+action),
        method: "POST",
        data: data,
        success: function (data) {
            if(callback)
            {
                callback(data);
            }
        },
        error: function () {
            if(error_callback)
            {
                error_callback();
            }
        }
    });
}

function cpl_load_session_id(callback) {
    api_js("http://api.clanplanet-liga.de/session/get_id.js", function (data)
    {
        if(session_id != data.session_id)
        {
            session_id = data.session_id;
            cpl_login_status = data.cpl_login;
            $(document).trigger("session_change");
            if(callback)
            {
                callback();
            }
        }
    });
}

function cpl_load_body(body_name, callback) {
    if(cpl_local_cache[body_name])
    {
        $("#view").html(cpl_local_cache[body_name]);
        cpl_template = body_name;
        if(callback)
        {
            callback();
        }
        $(document).trigger("body_loading_success");
    }
    else
    {
        $("#view").load("http://data.clanplanet-liga.de/templates/"+session_id+"/"+body_name+".html", function()
        {
            cpl_local_cache[body_name] = $("#view").html();
            cpl_template = body_name;
            if(callback)
            {
                callback();
            }
            $(document).trigger("body_loading_success");
        });
    }
}

function cpl_load_content(callback) {
    if(cpl_checkParam("cpl_site"))
    {
        site =  cpl_getParam("cpl_site");
    }
    else
    {
        site =  "index";
    }
    
    $.ajax({
        url: "http://data.clanplanet-liga.de/content/"+session_id+"/"+site+".html",
        success: function (data) {
            api_get("content/"+site+".json", function (body_api) {
                if(callback)
                {
                    callback(data, body_api.answer['template']);
                }
            });
        }
    });
}